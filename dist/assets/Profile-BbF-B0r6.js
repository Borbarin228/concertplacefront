import{a as e,c as t,i as n,l as r,n as i,o as a,r as o,s,t as c,u as l}from"./index-DArYt3Rj.js";var u=l(r(),1),d=a.ENDPOINTS.TICKETS.BASE_METH;const f={createTicket:t=>e.post(d,t),deleteTicket:t=>e.delete(`${d}/${t}`)};var p=o(),m=()=>{let e=t(),r=(0,u.useRef)(null),{user:o,isAuthenticated:l,getUserId:d,isAdmin:m,updateUser:h,checkAuth:g}=c(),[_,v]=(0,u.useState)(null),[y,b]=(0,u.useState)([]),[x,S]=(0,u.useState)([]),[C,w]=(0,u.useState)(!0),[T,E]=(0,u.useState)(null),[D,O]=(0,u.useState)(null),[k,A]=(0,u.useState)(null),[j,M]=(0,u.useState)(!1),[N,P]=(0,u.useState)({name:``,email:``,remove_avatar:!1});(0,u.useEffect)(()=>{if(!g()){e(`/login`);return}o&&(v(o),P({name:o.name||``,email:o.email||``,remove_avatar:!1}),o.avatar&&A(o.avatar.startsWith(`http`)?o.avatar:`${a.BASE_URL.replace(`/api`,``)}${o.avatar}`)),F(),I(),L()},[]);let F=async()=>{try{if(w(!0),E(null),!l){e(`/login`);return}let t=d();if(!t)throw Error(`User ID not found`);let r=(await n.getById(t)).data,i=r.data||r;v(i),P({name:i.name||``,email:i.email||``,remove_avatar:!1}),i.avatar&&A(i.avatar.startsWith(`http`)?i.avatar:`${a.BASE_URL.replace(`/api`,``)}${i.avatar}`)}catch(t){if(console.error(`Error fetching user:`,t),t.response?.status===401){e(`/login`);return}E(t.response?.data?.message||t.message||`Не удалось загрузить данные пользователя`)}finally{w(!1)}},I=async()=>{try{let e=d();if(!e)return;let t=await n.getTickets(e),r=t.data.data||t.data||[];b(Array.isArray(r)?r:[])}catch(e){console.error(`Error fetching tickets:`,e)}},L=async()=>{try{let e=d();if(!e)return;let t=await i.getAll(1),n=t.data.data||t.data||[];S((Array.isArray(n)?n:[]).filter(t=>t.user_id===e))}catch(e){console.error(`Error fetching concerts:`,e)}},R=e=>{if(e.target.files&&e.target.files[0]){let t=e.target.files[0],n=new FileReader;n.onload=e=>{e.target?.result&&(A(e.target.result),M(!0))},n.readAsDataURL(t)}},z=async t=>{if(t.preventDefault(),_)try{w(!0),E(null);let e=new FormData;e.append(`name`,N.name),e.append(`email`,N.email),N.remove_avatar&&e.append(`remove_avatar`,`1`),r.current?.files?.[0]&&e.append(`avatar`,r.current.files[0]),e.append(`_method`,`PUT`);let t=(await n.updateUser(_.id,e)).data,i=t.data||t;v(i),h(i),M(!1),O(`Профиль успешно обновлен!`),P({name:i.name||``,email:i.email||``,remove_avatar:!1}),i.avatar&&!N.remove_avatar?A(i.avatar.startsWith(`http`)?i.avatar:`${a.BASE_URL.replace(`/api`,``)}${i.avatar}`):N.remove_avatar&&A(null),r.current&&(r.current.value=``),setTimeout(()=>{O(null)},3e3)}catch(t){if(console.error(`Error updating user:`,t),t.response?.status===422&&t.response?.data?.errors){let e=t.response.data.errors;E(Object.values(e).flat().join(`, `)||`Ошибка валидации данных`)}else t.response?.status===401?(E(`Сессия истекла. Пожалуйста, войдите снова.`),e(`/login`)):E(t.response?.data?.message||t.message||`Не удалось обновить данные`);O(null)}finally{w(!1)}},B=async e=>{if(window.confirm(`Удалить билет?`))try{await f.deleteTicket(e),I()}catch(e){console.error(`Error deleting ticket:`,e),E(e.response?.data?.message||`Не удалось удалить билет`)}},V=async e=>{if(window.confirm(`Удалить мероприятие?`))try{await i.delete(e),L()}catch(e){console.error(`Error deleting concert:`,e),E(e.response?.data?.message||`Не удалось удалить мероприятие`)}},H=e=>{if(!e)return`—`;let t=new Date(e);return`${t.getDate()} ${[`января`,`февраля`,`марта`,`апреля`,`мая`,`июня`,`июля`,`августа`,`сентября`,`октября`,`ноября`,`декабря`][t.getMonth()]} ${t.getFullYear()}`},U=e=>{if(!e||e.trim()===``)return null;let t=e.trim();if(t.startsWith(`http`))return t;let n=a.BASE_URL.replace(`/api`,``);return`${n.endsWith(`/`)?n.slice(0,-1):n}/${t.startsWith(`/`)?t.slice(1):t}`};return C&&!_?(0,p.jsxs)(`div`,{className:`profile-loading`,children:[(0,p.jsx)(`div`,{className:`spinner`}),(0,p.jsx)(`p`,{children:`Загрузка профиля...`})]}):_?(0,p.jsxs)(`div`,{className:`profile-container`,children:[T&&(0,p.jsx)(`div`,{style:{color:`#e74c3c`,textAlign:`center`,marginBottom:`20px`,padding:`10px`,backgroundColor:`#fee`,borderRadius:`8px`},children:T}),D&&(0,p.jsx)(`div`,{style:{color:`#27ae60`,textAlign:`center`,marginBottom:`20px`,padding:`10px`,backgroundColor:`#d4edda`,borderRadius:`8px`},children:D}),(0,p.jsxs)(`form`,{onSubmit:z,children:[(0,p.jsxs)(`div`,{className:`profile-row`,children:[(0,p.jsxs)(`div`,{style:{display:`flex`,flexDirection:`column`,alignItems:`center`},children:[(0,p.jsx)(`label`,{htmlFor:`avatar-input`,style:{cursor:`pointer`},children:(0,p.jsx)(`img`,{id:`avatar-preview`,src:k||U(_.avatar)||`/images/user-placeholder.png`,className:`profile-avatar avatar-hover`,alt:`Аватар пользователя`,onError:e=>{e.currentTarget.src=`/images/user-placeholder.png`}})}),(0,p.jsx)(`input`,{id:`avatar-input`,ref:r,type:`file`,name:`avatar`,accept:`image/*`,onChange:R,style:{display:`none`}}),j&&(0,p.jsx)(`div`,{id:`unsaved-warning`,style:{display:`block`,color:`#e74c3c`,fontSize:`1.05rem`,marginTop:`8px`},children:`Вы не сохранили изменения`}),_.avatar&&(0,p.jsx)(`div`,{style:{marginTop:`8px`},children:(0,p.jsxs)(`label`,{style:{color:`#000`},children:[(0,p.jsx)(`input`,{type:`checkbox`,name:`remove_avatar`,checked:N.remove_avatar,onChange:e=>P({...N,remove_avatar:e.target.checked})}),` `,`Удалить аватар`]})})]}),(0,p.jsxs)(`div`,{className:`profile-fields`,children:[(0,p.jsxs)(`div`,{children:[(0,p.jsx)(`div`,{className:`profile-field-label`,children:`Имя Профиля`}),(0,p.jsx)(`div`,{className:`profile-field-box`,children:(0,p.jsx)(`input`,{type:`text`,name:`name`,className:`profile-input`,value:N.name,onChange:e=>P({...N,name:e.target.value}),required:!0})})]}),(0,p.jsxs)(`div`,{children:[(0,p.jsx)(`div`,{className:`profile-field-label`,children:`Почта`}),(0,p.jsx)(`div`,{className:`profile-field-box`,children:(0,p.jsx)(`input`,{type:`email`,name:`email`,className:`profile-input`,value:N.email,onChange:e=>P({...N,email:e.target.value}),required:!0})})]})]})]}),(0,p.jsx)(`button`,{type:`submit`,className:`confirm-btn`,disabled:C,children:C?`Сохранение...`:`Подтвердить изменения`})]}),(0,p.jsx)(`div`,{className:`profile-title`,children:`Мои Билеты`}),(0,p.jsx)(`div`,{className:`tickets-list`,children:y.length>0?y.map(e=>(0,p.jsxs)(`div`,{className:`ticket-card`,children:[(0,p.jsx)(`img`,{src:U(e.concert?.user?.avatar)||`/images/user-placeholder.png`,className:`ticket-artist-photo`,alt:`Фото артиста`,onError:e=>{e.currentTarget.src=`/images/user-placeholder.png`}}),(0,p.jsxs)(`div`,{className:`ticket-info`,children:[(0,p.jsx)(`div`,{className:`ticket-title`,children:e.concert?.user?.name||`Артист`}),(0,p.jsxs)(`div`,{className:`ticket-place`,children:[e.concert?.city||``,` – `,e.concert?.place||``]}),(0,p.jsx)(`div`,{className:`ticket-date`,children:H(e.concert?.start_at)})]}),(0,p.jsx)(`span`,{className:`ticket-category`,children:e.category?.name||``}),(0,p.jsx)(`span`,{className:`ticket-cut`}),(0,p.jsxs)(`span`,{className:`ticket-qty`,children:[`X`,e.number||1]}),(0,p.jsx)(`button`,{type:`button`,onClick:()=>B(e.id),className:`delete-ticket-btn`,children:`✖`})]},e.id)):(0,p.jsx)(`div`,{style:{color:`#888`,fontSize:`1.1rem`,textAlign:`center`},children:`У вас пока нет билетов.`})}),(0,p.jsx)(s,{to:`/concert/create`,className:`create-event-btn`,children:`Создать мероприятие`}),(0,p.jsx)(`div`,{className:`my-events-title`,children:`Мои мероприятия`}),(0,p.jsx)(`div`,{className:`concert-list`,children:x.length>0?x.map(e=>(0,p.jsxs)(`div`,{className:`concert-card`,children:[(0,p.jsx)(`img`,{src:U(e.user?.avatar)||`/images/user-placeholder.png`,className:`concert-photo`,alt:`Фото пользователя`,onError:e=>{e.currentTarget.src=`/images/user-placeholder.png`}}),(0,p.jsxs)(`div`,{className:`concert-info`,children:[(0,p.jsx)(`div`,{className:`concert-title`,children:e.user?.name||`Без имени`}),(0,p.jsxs)(`div`,{className:`concert-place`,children:[e.city,` – `,e.place]}),(0,p.jsx)(`div`,{className:`concert-date`,children:H(e.start_at)})]}),(0,p.jsx)(`button`,{type:`button`,onClick:()=>V(e.id),className:`delete-concert-btn`,children:`✖`})]},e.id)):(0,p.jsx)(`div`,{style:{color:`#000`,fontSize:`1.1rem`,textAlign:`center`},children:`Вы ещё не создавали мероприятий.`})})]}):(0,p.jsx)(`div`,{className:`profile-container`,children:(0,p.jsx)(`div`,{style:{textAlign:`center`,color:`#000`,fontSize:`1.1rem`},children:`Данные пользователя не найдены`})})};export{m as default};